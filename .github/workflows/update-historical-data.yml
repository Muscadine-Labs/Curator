name: Update Historical Data

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch DefiLlama data
        run: |
          # Fetch current fees data from DefiLlama
          curl -s "https://api.llama.fi/summary/fees/muscadine?dataType=dailyFees" > /tmp/defillama-fees.json
          
          # Extract chart data and format for our use
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/tmp/defillama-fees.json', 'utf8'));
            
            // Read existing data if it exists
            let existingData = { fees: [], lastUpdated: null };
            try {
              existingData = JSON.parse(fs.readFileSync('data/historical-fees.json', 'utf8'));
            } catch (e) {
              console.log('No existing data found, starting fresh');
            }
            
            // Merge new data with existing
            const newPoints = (data.totalDataChart || []).map(([ts, val]) => ({
              timestamp: ts,
              date: new Date(ts * 1000).toISOString().split('T')[0],
              dailyFees: val,
            }));
            
            // Create a map of existing data by date
            const existingMap = new Map(existingData.fees.map(p => [p.date, p]));
            
            // Add/update with new data
            for (const point of newPoints) {
              existingMap.set(point.date, point);
            }
            
            // Convert back to array and sort
            const merged = Array.from(existingMap.values()).sort((a, b) => 
              new Date(a.date).getTime() - new Date(b.date).getTime()
            );
            
            // Save merged data
            const output = {
              fees: merged,
              lastUpdated: new Date().toISOString(),
              source: 'DefiLlama',
              protocol: 'muscadine',
              total30d: data.total30d || null,
              totalAllTime: data.totalAllTime || null,
            };
            
            fs.writeFileSync('data/historical-fees.json', JSON.stringify(output, null, 2));
            console.log('Updated historical-fees.json with', merged.length, 'data points');
          "

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/historical-fees.json
          git diff --staged --quiet || git commit -m "chore: update historical fees data [skip ci]"
          git push
